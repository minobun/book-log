# 感想
昔の仕様ではあるが、簡潔にNextを知れるのはよさそう。
App RouterやPages Routerの違いを知るには簡単にしれそう。

SSRの条件とかもろもろ勘違いしていた。恥ずかしい。

# メモ
Webアプリケーションの開発
- JavaScript利用によってHTML要素を変更していくDOM操作が手続き的で非常に複雑であった。
- Reactは宣言的にDOM操作を行うために開発された。
- Reactでは画面表示されるHTMLをすべてJavaScriptで実装するため、課題がある。
  - JavaScriptファイルのロードによる画面描画の遅延
  - 検索エンジンのクローラーによるメタ情報読み込み不可
  - APIサーバーの別実装が必要
- Nex.jsはこれらの課題を解決する。
  - あらかじめHTMLを生成し、ブラウザ側でのHTML生成をなくし、描画速度を短縮
  - 検索エンジンのクローラーも読み込みやすくなる。
  - APIサーバーとしての役割も担える。
  
Reactが実現したいこと
- JSXによる宣言的なUIの実装
- 状態の管理
  
Next.jsはVercelが開発しているオープンソースのフレームワーク
Next.jsの主な機能
- レンダリング
  - サーバーサイドレンダリング
    - `getServerSideProp`を利用する。
  - 静的サイト生成
    - `getStaticProps`を利用する。
- ファイルベースルーティング
  - ダイナミックルーティング
    - `pages/post/[slug].tsx`のようにファイル名に`[]`記号を利用するとその部分が変数になる。
  - APIルート
    - `pages/api`というディレクトリに配置されたファイルはAPIルートとして処理される。
- Incremental Static Regeneration（ISR)
  - SSGを行った場合、ビルドしなおさなければページの内容を更新できない。
    - ページにリクエストが来た際にビルド済みの静的なページを表示しながら、裏側で再レンダリングする。
  - `getStaticProps`の戻り値として`revalidate`を追加することで可能。
    - `revalidate`の値の秒数の間はキャッシュされ、それ以降のリクエストが来たら再レンダリングを行う。
- 高速リロード
  - コンポーネントだけを名前付きでエクスポートすると可能
- リソースの最適化
  - 画像のサイズを最適化する。
    - 画像のサイズを表示サイズに合わせて変換してから配信
    - ビューポートに入るまで画像の読み込みを遅延させる。
  - フォントをビルド時に読み込んでNext.jsのアプリケーションに埋め込み可能
- ミドルウェア
  - リクエストを処理する前後に任意の処理を挟むことができる。
  - プロジェクトルートに`middlware.ts`に`middleware`関数を実装してエクスポートすることで設定できる。
    - 対象のURLを絞ることもできる。
- 高速なコンパイラ/バンドラ
  - SWCというRust言語製のライブラリを利用した独自のコンパイラが採用されている。
    - Babelよりも17倍以上速くなっている。
    - RustやGoはコンパイルして実行可能ファイル（CPUへの直接の命令ファイル）に変換される。
    - ランタイムを必要とするJavaScriptのようなスクリプト言語よりも高い実行速度を得られる。
    - 参考
      - Nuxt（Vue.jsを利用したSSRフレームワーク）ではViteというトランスパイル/バンドルライブラリを利用して言うr。
        - ViteはGo製のesbuildを利用している。
    - バンドラもTurbopackに置き換えるプロジェクトが進んでいる。

## ReactとNext.jsの進化
### React18
- アプリケーションの表示や動作のパフォーマンスを向上させる新機能
- サーバーサイドレンダリングを強化する新機能

~並行レンダリング~
アプリケーションのレンダリングが並行化した。
以前は一度始まったレンダリングは必ず最後まで行われてから次のレンダリングに移行していた。
`startTransition`という関数に後回しにしたい状態の更新処理をコールバク関数として渡すことが可能

~非同期SSR~
コンポーネント単位で非同期にサーバーサイドレンダリングを行えるようになった。
`Suspense`というコンポーネントで区切られた単位で非同期にサーバーサイドレンダリングを行う。

__ハイドレーション__ SSRしたHTMLにJavaScriptを読み込んでアプリケーションを操作可能にすること
選択的ハイドレーション：SSR処理が重いコンポーネントがレンダリングされるのを待つことなく、ユーザーはアプリケーションを操作できる。

### Next.js 13

2023年５月に最新のメジャーーバージョン

ファイルベースルーティングの仕組みが大幅に見直された。

- App Router
  - pagesディレクトリではなくappディレクトリにソースコードを配置する。
    - フォルダがURLに対応するようになった。
      - app/dashboardというフォルダがこのURLに対応する。
      - 表示内容はapp/dashboard/page.tsxに記述
    - フォルダ内の特殊なページ
      - `error.tsx`
        - `ErrorBoundary`として機能
      - `layout.tsx`
        - そのフォルダとその配下のフォルダに対応するページに共通のUIを記述可能
      - `loading.tsx`
        - `Suspense`として機能
- レンダリング
  - サーバーコンポーネント
    - デフォルトでサーバーコンポーネントとなる。
    - 利点
      - 配信バンドルが軽量
      - 非同期にレンダリングできる
      - バックエンドに直接アクセスできる
    - 欠点
      - ブラウザAPIが利用できない。
        - よって'use client'を記述する必要がある。
        - →クライアントコンポーネントと呼ばれる。
- 静的レンダリング/動的レンダリング
  - `fetch()`の設定や`cookies()`、`headers()`という動的関数と呼ばれるAPIを利用していることを条件として自動で動的レンダリングにする。
- データ取得
  - 子ぽーねん都内で非同期関数をawaitすうｒことができる。

